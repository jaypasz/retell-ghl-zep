{
  "flow_name": "Appointment Booking & Sales Qualification",
  "description": "Comprehensive conversation flow with Zep memory, GHL integration, and appointment booking",
  "version": "1.0",
  "nodes": [
    {
      "node_id": "call_start",
      "node_name": "Call Start",
      "type": "start",
      "description": "Entry point for all inbound calls",
      "next_node": "webhook_trigger"
    },
    {
      "node_id": "webhook_trigger",
      "node_name": "Webhook Trigger",
      "type": "webhook",
      "description": "Send call data to backend and load customer context",
      "webhook_config": {
        "url": "{{BASE_URL}}/retell/inbound",
        "method": "POST",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "call_id": "{{call_id}}",
          "from_number": "{{from_number}}",
          "to_number": "{{to_number}}",
          "metadata": "{{metadata}}"
        }
      },
      "next_node": "greeting_router"
    },
    {
      "node_id": "greeting_router",
      "node_name": "Greeting Router",
      "type": "branch",
      "description": "Route to appropriate greeting based on customer status",
      "conditions": [
        {
          "if": "{{customer_known}} === 'yes' && {{existing_appointments.length}} > 0",
          "next_node": "greeting_returning_with_appointment"
        },
        {
          "if": "{{customer_known}} === 'yes'",
          "next_node": "greeting_returning"
        },
        {
          "if": "{{customer_known}} === 'no'",
          "next_node": "greeting_new"
        }
      ],
      "default_next_node": "greeting_generic"
    },
    {
      "node_id": "greeting_new",
      "node_name": "New Customer Greeting",
      "type": "speak",
      "script": "{{langfuse_prompt:greeting-new-customer}}",
      "script_fallback": "Hi! Thanks for calling. My name is Sarah, your AI assistant. How can I help you today?",
      "langfuse_metadata": {
        "prompt_name": "greeting-new-customer",
        "track_usage": true
      },
      "next_node": "intent_recognition"
    },
    {
      "node_id": "greeting_returning",
      "node_name": "Returning Customer Greeting",
      "type": "speak",
      "script": "{{langfuse_prompt:greeting-returning-customer}}",
      "script_fallback": "Hi {{customer_name}}! Great to hear from you again. How can I help you today?",
      "langfuse_metadata": {
        "prompt_name": "greeting-returning-customer",
        "track_usage": true,
        "customer_context": {
          "known": true,
          "facts_count": "{{customer_facts.length}}"
        }
      },
      "next_node": "intent_recognition"
    },
    {
      "node_id": "greeting_returning_with_appointment",
      "node_name": "Returning Customer With Appointment",
      "type": "speak",
      "script": "Hi {{customer_name}}! I see you have an appointment scheduled for {{existing_appointments[0].formatted}}. Is that what you're calling about, or is there something else I can help you with?",
      "next_node": "intent_recognition"
    },
    {
      "node_id": "greeting_generic",
      "node_name": "Generic Greeting",
      "type": "speak",
      "script": "Hi! Thanks for calling. How can I help you today?",
      "next_node": "intent_recognition"
    },
    {
      "node_id": "intent_recognition",
      "node_name": "Intent Recognition",
      "type": "intent_classifier",
      "description": "Identify what the customer wants to do",
      "intents": [
        "book_appointment",
        "reschedule_appointment",
        "cancel_appointment",
        "ask_question",
        "request_information",
        "speak_to_human",
        "general_inquiry"
      ],
      "confidence_threshold": 0.7,
      "langfuse_metadata": {
        "track_intent": true,
        "generation_name": "intent-classification",
        "track_confidence": true
      },
      "next_nodes": {
        "book_appointment": "check_has_name",
        "reschedule_appointment": "reschedule_flow_start",
        "cancel_appointment": "cancel_flow_start",
        "ask_question": "faq_handler",
        "request_information": "info_gathering_start",
        "speak_to_human": "transfer_requested",
        "general_inquiry": "info_gathering_start"
      },
      "low_confidence_node": "clarification"
    },
    {
      "node_id": "clarification",
      "node_name": "Clarification Node",
      "type": "speak",
      "script": "I want to make sure I understand correctly. Are you looking to book an appointment, reschedule an existing appointment, or do you have a question I can help with?",
      "next_node": "intent_recognition"
    },
    {
      "node_id": "check_has_name",
      "node_name": "Check Has Name",
      "type": "branch",
      "description": "Check if we have customer name before proceeding",
      "conditions": [
        {
          "if": "{{customer_name}} !== null && {{customer_name}} !== ''",
          "next_node": "check_availability"
        }
      ],
      "default_next_node": "collect_name"
    },
    {
      "node_id": "collect_name",
      "node_name": "Name Collection",
      "type": "collect_input",
      "script": "Great! May I ask who I'm speaking with?",
      "variable_name": "customer_name",
      "validation": {
        "type": "text",
        "min_length": 2
      },
      "next_node": "confirm_name"
    },
    {
      "node_id": "confirm_name",
      "node_name": "Confirm Name",
      "type": "speak",
      "script": "Nice to meet you, {{customer_name}}!",
      "next_node": "check_availability"
    },
    {
      "node_id": "check_availability",
      "node_name": "Check Availability",
      "type": "branch",
      "description": "Check if calendar has available slots",
      "conditions": [
        {
          "if": "{{available_slots.length}} > 0",
          "next_node": "present_slots"
        }
      ],
      "default_next_node": "no_availability"
    },
    {
      "node_id": "present_slots",
      "node_name": "Present Available Slots",
      "type": "speak",
      "script": "Perfect! I have several times available. Let me share the next few options with you:\n{{#each available_slots}}\n{{add @index 1}}. {{this.formatted}}\n{{/each}}\n\nWhich one works best for you?",
      "next_node": "collect_slot_selection"
    },
    {
      "node_id": "collect_slot_selection",
      "node_name": "Collect Slot Selection",
      "type": "collect_input",
      "description": "Customer selects their preferred time slot",
      "variable_name": "selected_slot_index",
      "validation": {
        "type": "number",
        "min": 1,
        "max": "{{available_slots.length}}"
      },
      "retry_script": "I didn't catch which time works for you. Could you tell me the number of your preferred slot?",
      "max_retries": 2,
      "next_node": "confirm_slot_selection",
      "fallback_node": "transfer_requested"
    },
    {
      "node_id": "confirm_slot_selection",
      "node_name": "Confirm Slot Selection",
      "type": "speak",
      "script": "Great choice! Just to confirm, that's {{selected_slot.formatted}}. Is that correct?",
      "next_node": "confirmation_response"
    },
    {
      "node_id": "confirmation_response",
      "node_name": "Confirmation Response",
      "type": "collect_input",
      "variable_name": "slot_confirmed",
      "validation": {
        "type": "boolean"
      },
      "next_node": "confirmation_branch"
    },
    {
      "node_id": "confirmation_branch",
      "node_name": "Confirmation Branch",
      "type": "branch",
      "conditions": [
        {
          "if": "{{slot_confirmed}} === true",
          "next_node": "book_appointment_action"
        }
      ],
      "default_next_node": "present_slots"
    },
    {
      "node_id": "book_appointment_action",
      "node_name": "Book Appointment",
      "type": "custom_tool",
      "description": "Call backend to book the appointment",
      "tool_config": {
        "url": "{{BASE_URL}}/appointments/book",
        "method": "POST",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "phone": "{{from_number}}",
          "slot_time": "{{selected_slot.datetime}}",
          "title": "Appointment with {{customer_name}}",
          "appointment_data": {
            "customer_name": "{{customer_name}}",
            "call_id": "{{call_id}}"
          }
        }
      },
      "on_success": "appointment_confirmation",
      "on_error": "booking_error"
    },
    {
      "node_id": "appointment_confirmation",
      "node_name": "Appointment Confirmation",
      "type": "speak",
      "script": "{{langfuse_prompt:appointment-confirmation}}",
      "script_fallback": "Perfect! I've successfully booked your appointment for {{selected_slot.formatted}}. You'll receive a confirmation text message with all the details shortly. Is there anything else I can help you with today?",
      "langfuse_metadata": {
        "prompt_name": "appointment-confirmation",
        "track_usage": true,
        "event": "appointment_booked",
        "appointment_details": {
          "slot": "{{selected_slot.formatted}}",
          "contact_id": "{{ghl_contact_id}}"
        }
      },
      "langfuse_score": {
        "name": "appointment_success",
        "value": 1,
        "comment": "Appointment successfully booked"
      },
      "next_node": "anything_else_branch"
    },
    {
      "node_id": "booking_error",
      "node_name": "Booking Error Handler",
      "type": "speak",
      "script": "I apologize, but I'm having trouble booking that appointment right now. Let me connect you with someone who can help you complete this booking.",
      "next_node": "transfer_to_human"
    },
    {
      "node_id": "no_availability",
      "node_name": "No Availability",
      "type": "speak",
      "script": "I apologize, but I don't have any availability showing in the system right now. What I can do is have someone call you back within 24 hours to schedule your appointment. Would that work for you?",
      "next_node": "collect_callback_preference"
    },
    {
      "node_id": "collect_callback_preference",
      "node_name": "Collect Callback Preference",
      "type": "collect_input",
      "variable_name": "wants_callback",
      "validation": {
        "type": "boolean"
      },
      "next_node": "callback_branch"
    },
    {
      "node_id": "callback_branch",
      "node_name": "Callback Branch",
      "type": "branch",
      "conditions": [
        {
          "if": "{{wants_callback}} === true",
          "next_node": "create_callback_task"
        }
      ],
      "default_next_node": "polite_close"
    },
    {
      "node_id": "create_callback_task",
      "node_name": "Create Callback Task",
      "type": "custom_tool",
      "description": "Create a task in GHL for callback",
      "tool_config": {
        "url": "{{BASE_URL}}/tasks/create",
        "method": "POST",
        "body": {
          "contact_id": "{{ghl_contact_id}}",
          "task_type": "callback",
          "priority": "high",
          "notes": "Customer called about appointment booking - no availability shown"
        }
      },
      "next_node": "callback_confirmation"
    },
    {
      "node_id": "callback_confirmation",
      "node_name": "Callback Confirmation",
      "type": "speak",
      "script": "Perfect! Someone from our team will call you back at {{from_number}} within 24 hours to schedule your appointment. Is there anything else I can help you with?",
      "next_node": "anything_else_branch"
    },
    {
      "node_id": "reschedule_flow_start",
      "node_name": "Reschedule Flow Start",
      "type": "branch",
      "description": "Check if customer has existing appointments",
      "conditions": [
        {
          "if": "{{existing_appointments.length}} > 0",
          "next_node": "confirm_reschedule_appointment"
        }
      ],
      "default_next_node": "no_existing_appointment"
    },
    {
      "node_id": "confirm_reschedule_appointment",
      "node_name": "Confirm Reschedule Appointment",
      "type": "speak",
      "script": "I can help you reschedule your appointment currently scheduled for {{existing_appointments[0].formatted}}. Would you like to see available times?",
      "next_node": "reschedule_confirmation_response"
    },
    {
      "node_id": "reschedule_confirmation_response",
      "node_name": "Reschedule Confirmation Response",
      "type": "collect_input",
      "variable_name": "wants_reschedule",
      "validation": {
        "type": "boolean"
      },
      "next_node": "reschedule_branch"
    },
    {
      "node_id": "reschedule_branch",
      "node_name": "Reschedule Branch",
      "type": "branch",
      "conditions": [
        {
          "if": "{{wants_reschedule}} === true",
          "next_node": "present_slots"
        }
      ],
      "default_next_node": "anything_else_branch"
    },
    {
      "node_id": "cancel_flow_start",
      "node_name": "Cancel Flow Start",
      "type": "branch",
      "description": "Check if customer has existing appointments to cancel",
      "conditions": [
        {
          "if": "{{existing_appointments.length}} > 0",
          "next_node": "confirm_cancellation"
        }
      ],
      "default_next_node": "no_existing_appointment"
    },
    {
      "node_id": "confirm_cancellation",
      "node_name": "Confirm Cancellation",
      "type": "speak",
      "script": "I can help you cancel your appointment scheduled for {{existing_appointments[0].formatted}}. Are you sure you want to cancel this appointment?",
      "next_node": "cancellation_confirmation_response"
    },
    {
      "node_id": "cancellation_confirmation_response",
      "node_name": "Cancellation Confirmation Response",
      "type": "collect_input",
      "variable_name": "confirm_cancel",
      "validation": {
        "type": "boolean"
      },
      "next_node": "cancellation_branch"
    },
    {
      "node_id": "cancellation_branch",
      "node_name": "Cancellation Branch",
      "type": "branch",
      "conditions": [
        {
          "if": "{{confirm_cancel}} === true",
          "next_node": "cancel_appointment_action"
        }
      ],
      "default_next_node": "cancellation_declined"
    },
    {
      "node_id": "cancel_appointment_action",
      "node_name": "Cancel Appointment Action",
      "type": "custom_tool",
      "description": "Call backend to cancel the appointment",
      "tool_config": {
        "url": "{{BASE_URL}}/appointments/cancel",
        "method": "DELETE",
        "body": {
          "event_id": "{{existing_appointments[0].id}}"
        }
      },
      "on_success": "cancellation_success",
      "on_error": "cancellation_error"
    },
    {
      "node_id": "cancellation_success",
      "node_name": "Cancellation Success",
      "type": "speak",
      "script": "Your appointment has been successfully cancelled. You'll receive a confirmation message shortly. Is there anything else I can help you with?",
      "next_node": "anything_else_branch"
    },
    {
      "node_id": "cancellation_error",
      "node_name": "Cancellation Error",
      "type": "speak",
      "script": "I apologize, but I'm having trouble cancelling that appointment right now. Let me connect you with someone who can help.",
      "next_node": "transfer_to_human"
    },
    {
      "node_id": "cancellation_declined",
      "node_name": "Cancellation Declined",
      "type": "speak",
      "script": "No problem! Your appointment for {{existing_appointments[0].formatted}} is still scheduled. Is there anything else I can help you with?",
      "next_node": "anything_else_branch"
    },
    {
      "node_id": "no_existing_appointment",
      "node_name": "No Existing Appointment",
      "type": "speak",
      "script": "I don't see any existing appointments in our system. Would you like to schedule a new appointment instead?",
      "next_node": "book_new_instead_response"
    },
    {
      "node_id": "book_new_instead_response",
      "node_name": "Book New Instead Response",
      "type": "collect_input",
      "variable_name": "wants_new_booking",
      "validation": {
        "type": "boolean"
      },
      "next_node": "book_new_branch"
    },
    {
      "node_id": "book_new_branch",
      "node_name": "Book New Branch",
      "type": "branch",
      "conditions": [
        {
          "if": "{{wants_new_booking}} === true",
          "next_node": "check_has_name"
        }
      ],
      "default_next_node": "anything_else_branch"
    },
    {
      "node_id": "info_gathering_start",
      "node_name": "Information Gathering Start",
      "type": "speak",
      "script": "I'd be happy to help you with that. Can you tell me a bit more about what you're looking for?",
      "next_node": "collect_inquiry_details"
    },
    {
      "node_id": "collect_inquiry_details",
      "node_name": "Collect Inquiry Details",
      "type": "collect_input",
      "variable_name": "inquiry_details",
      "validation": {
        "type": "text"
      },
      "next_node": "faq_handler"
    },
    {
      "node_id": "faq_handler",
      "node_name": "FAQ Handler",
      "type": "faq",
      "description": "Handle common questions",
      "knowledge_base": [
        {
          "question": "hours of operation",
          "answer": "We're open Monday through Friday, 9 AM to 5 PM Eastern Time.",
          "keywords": ["hours", "open", "when", "time"]
        },
        {
          "question": "location",
          "answer": "We're located at [Your Address]. Would you like me to send you directions?",
          "keywords": ["location", "where", "address", "directions"]
        },
        {
          "question": "pricing",
          "answer": "Pricing varies based on your specific needs. I'd recommend scheduling a consultation where we can provide you with an accurate quote.",
          "keywords": ["price", "cost", "how much", "pricing"]
        },
        {
          "question": "how it works",
          "answer": "Great question! We use advanced AI voice technology to handle your calls, integrate with your CRM, and manage appointments automatically. Would you like to schedule a demo?",
          "keywords": ["how", "works", "process", "what do you do"]
        }
      ],
      "on_match": "faq_answer",
      "no_match_node": "transfer_requested"
    },
    {
      "node_id": "faq_answer",
      "node_name": "FAQ Answer",
      "type": "speak",
      "script": "{{faq_response}}",
      "next_node": "anything_else_branch"
    },
    {
      "node_id": "anything_else_branch",
      "node_name": "Anything Else Branch",
      "type": "speak",
      "script": "Is there anything else I can help you with today?",
      "next_node": "anything_else_response"
    },
    {
      "node_id": "anything_else_response",
      "node_name": "Anything Else Response",
      "type": "collect_input",
      "variable_name": "has_more_questions",
      "validation": {
        "type": "boolean"
      },
      "next_node": "more_questions_branch"
    },
    {
      "node_id": "more_questions_branch",
      "node_name": "More Questions Branch",
      "type": "branch",
      "conditions": [
        {
          "if": "{{has_more_questions}} === true",
          "next_node": "intent_recognition"
        }
      ],
      "default_next_node": "goodbye"
    },
    {
      "node_id": "transfer_requested",
      "node_name": "Transfer Requested",
      "type": "speak",
      "script": "Of course, I'd be happy to connect you with someone from our team. One moment please.",
      "next_node": "transfer_to_human"
    },
    {
      "node_id": "transfer_to_human",
      "node_name": "Transfer to Human",
      "type": "transfer",
      "description": "Transfer call to human agent",
      "transfer_config": {
        "department": "general",
        "transfer_type": "warm",
        "context_to_pass": {
          "customer_name": "{{customer_name}}",
          "call_reason": "{{intent}}",
          "conversation_summary": "{{conversation_history}}"
        }
      },
      "next_node": "call_end"
    },
    {
      "node_id": "polite_close",
      "node_name": "Polite Close",
      "type": "speak",
      "script": "I understand. If you change your mind or need anything else, feel free to give us a call. Have a great day!",
      "next_node": "call_end"
    },
    {
      "node_id": "goodbye",
      "node_name": "Goodbye",
      "type": "speak",
      "script": "Thank you for calling! Have a wonderful day!",
      "next_node": "call_end"
    },
    {
      "node_id": "call_end",
      "node_name": "Call End",
      "type": "end_call",
      "description": "End the call and trigger after-call work",
      "after_call_webhook": {
        "url": "{{BASE_URL}}/retell/call-ended",
        "method": "POST",
        "body": {
          "call_id": "{{call_id}}",
          "transcript": "{{transcript}}",
          "duration": "{{call_duration}}",
          "outcome": "{{call_outcome}}",
          "langfuse_metadata": {
            "intents_detected": "{{all_intents}}",
            "appointments_booked": "{{appointments_booked_count}}",
            "customer_known": "{{customer_known}}",
            "transfers": "{{transfer_count}}"
          }
        }
      },
      "langfuse_trace_update": {
        "output": "{{call_outcome}}",
        "metadata": {
          "call_duration": "{{call_duration}}",
          "outcome": "{{call_outcome}}",
          "customer_satisfaction": "{{sentiment_score}}"
        }
      }
    },
    {
      "node_id": "error_handler",
      "node_name": "Error Handler",
      "type": "speak",
      "script": "I apologize, I didn't quite catch that. Could you repeat that for me?",
      "retry_count": 0,
      "max_retries": 2,
      "next_node": "last_input_node",
      "fallback_node": "transfer_to_human"
    },
    {
      "node_id": "technical_error",
      "node_name": "Technical Error",
      "type": "speak",
      "script": "I apologize, I'm experiencing a technical issue. Let me connect you with someone who can help you right away.",
      "next_node": "transfer_to_human"
    }
  ],
  "global_settings": {
    "voice": "female",
    "language": "en-US",
    "speech_rate": 1.0,
    "interruption_sensitivity": 0.5,
    "silence_timeout": 5000,
    "max_call_duration": 1800,
    "enable_sentiment_analysis": true,
    "enable_background_noise_suppression": true
  },
  "langfuse_integration": {
    "enabled": true,
    "trace_all_calls": true,
    "prompt_management": {
      "greeting_new_customer": {
        "prompt_name": "greeting-new-customer",
        "fallback": "Hi! Thanks for calling. My name is Sarah, your AI assistant. How can I help you today?"
      },
      "greeting_returning_customer": {
        "prompt_name": "greeting-returning-customer",
        "fallback": "Hi {{customer_name}}! Great to hear from you again. How can I help you today?"
      },
      "appointment_confirmation": {
        "prompt_name": "appointment-confirmation",
        "fallback": "Perfect! I've successfully booked your appointment for {{selected_slot.formatted}}. You'll receive a confirmation text message with all the details shortly."
      },
      "objection_handling_price": {
        "prompt_name": "objection-price",
        "fallback": "I understand budget is important. The investment really depends on your specific needs. What I'd recommend is scheduling a consultation where we can give you exact pricing based on your situation."
      },
      "faq_hours": {
        "prompt_name": "faq-hours",
        "fallback": "We're open Monday through Friday, 9 AM to 5 PM Eastern Time."
      }
    },
    "observation_metadata": {
      "track_intents": true,
      "track_appointments": true,
      "track_sentiment": true,
      "track_customer_status": true
    }
  },
  "environment_variables": {
    "BASE_URL": "https://your-app.railway.app",
    "company_name": "Your Company Name",
    "LANGFUSE_PUBLIC_KEY": "{{LANGFUSE_PUBLIC_KEY}}",
    "LANGFUSE_SECRET_KEY": "{{LANGFUSE_SECRET_KEY}}",
    "LANGFUSE_BASE_URL": "https://cloud.langfuse.com"
  },
  "error_handling": {
    "default_error_node": "error_handler",
    "technical_error_node": "technical_error",
    "max_global_retries": 3
  },
  "analytics": {
    "track_events": [
      "call_started",
      "intent_detected",
      "appointment_booked",
      "appointment_cancelled",
      "appointment_rescheduled",
      "transfer_requested",
      "call_ended"
    ],
    "enable_sentiment_tracking": true,
    "langfuse_events": {
      "call_started": {
        "trace_name": "inbound-call",
        "metadata": ["from_number", "customer_known", "has_existing_appointments"]
      },
      "intent_detected": {
        "generation_name": "intent-classification",
        "metadata": ["intent", "confidence"]
      },
      "appointment_booked": {
        "event_name": "appointment-booked",
        "score": {
          "name": "appointment_success",
          "value": 1
        },
        "metadata": ["contact_id", "slot_time", "calendar_id"]
      },
      "appointment_cancelled": {
        "event_name": "appointment-cancelled",
        "metadata": ["event_id", "reason"]
      },
      "appointment_rescheduled": {
        "event_name": "appointment-rescheduled",
        "metadata": ["event_id", "old_time", "new_time"]
      },
      "transfer_requested": {
        "event_name": "transfer-to-human",
        "score": {
          "name": "ai_resolution",
          "value": 0,
          "comment": "Required human intervention"
        },
        "metadata": ["reason", "transfer_department"]
      },
      "call_ended": {
        "trace_update": true,
        "metadata": ["duration", "outcome", "sentiment_score", "intents", "actions_completed"]
      }
    }
  },
  "retell_custom_tools": [
    {
      "tool_id": "book_appointment",
      "tool_name": "Book Appointment",
      "description": "Books an appointment for the customer",
      "endpoint": "{{BASE_URL}}/appointments/book",
      "method": "POST",
      "parameters": {
        "contact_id": "string",
        "slot_time": "string",
        "title": "string",
        "customer_phone": "string"
      },
      "langfuse_tracking": {
        "generation_name": "book-appointment-tool",
        "track_input": true,
        "track_output": true,
        "score_on_success": {
          "name": "tool_success",
          "value": 1
        }
      }
    },
    {
      "tool_id": "reschedule_appointment",
      "tool_name": "Reschedule Appointment",
      "description": "Reschedules an existing appointment",
      "endpoint": "{{BASE_URL}}/appointments/reschedule",
      "method": "POST",
      "parameters": {
        "event_id": "string",
        "new_start_time": "string"
      },
      "langfuse_tracking": {
        "generation_name": "reschedule-appointment-tool",
        "track_input": true,
        "track_output": true
      }
    },
    {
      "tool_id": "cancel_appointment",
      "tool_name": "Cancel Appointment",
      "description": "Cancels an appointment",
      "endpoint": "{{BASE_URL}}/appointments/cancel",
      "method": "POST",
      "parameters": {
        "event_id": "string"
      },
      "langfuse_tracking": {
        "generation_name": "cancel-appointment-tool",
        "track_input": true,
        "track_output": true
      }
    }
  ]
}
